<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Student Group Shuffle + Wheel</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{ --ink:#0f1226; --muted:#9fb0d8; --line:#243056; --bg:#0b1026; --card:#0e1533; }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;color:#e6ecff;
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background: radial-gradient(1200px 600px at 20% -20%, #1a2150 0%, transparent 60%),
                radial-gradient(900px 500px at 120% 20%, #093a54 0%, transparent 50%),
                #060b1a;
    overflow-x:hidden;
  }

  /* Header */
  .hero{background:linear-gradient(135deg,#111b3d,#112a55);border-bottom:1px solid #1a2450;position:relative;overflow:hidden}
  .neon-title{
    margin:0;font-size:34px;padding:18px 16px;letter-spacing:.02em;
    background:linear-gradient(90deg,#22d3ee,#7c3aed,#22d3ee);
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px rgba(124,58,237,.8),0 0 22px rgba(34,211,238,.6);
  }
  .wrap{max-width:1200px;margin:0 auto;padding:18px 16px}

  /* Layout & cards */
  .grid{display:grid;gap:18px;grid-template-columns:1fr}
  @media(min-width:1024px){.grid{grid-template-columns:1fr 2fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 0 0 1px rgba(124,58,237,.15),0 20px 60px rgba(0,0,0,.35)}
  .pad{padding:16px}

  /* Inputs/buttons */
  textarea,input,button,select{font:inherit}
  textarea{width:100%;height:240px;padding:10px;border:1px solid #2c3a6f;border-radius:12px;background:#0a1638;color:#e6ecff}
  input,select{width:100%;padding:8px 10px;border:1px solid #2c3a6f;border-radius:12px;background:#0a1638;color:#e6ecff}
  textarea:focus,input:focus,select:focus{outline:none;border-color:#5b94ff;box-shadow:0 0 0 2px rgba(91,148,255,.25)}

  /* --- NEW: ensure dropdown options are readable --- */
  select{ color:#e6ecff; }
  select option{
    color:#e6ecff;
    background:#0a1638;
  }

  label{font-size:13px;font-weight:700;display:block;margin:10px 0 6px;color:#c9d4ff}
  .btn{display:inline-flex;gap:8px;align-items:center;padding:12px 16px;border-radius:12px;border:1px solid #2c3a6f;background:#0f1a44;color:#e6ecff;font-weight:700;cursor:pointer;transition:transform .06s ease,filter .2s ease}
  .btn.primary{background:radial-gradient(100% 100% at 50% 0%,#7c3aed,#53389e 60%,#312e81 100%);border-color:transparent;box-shadow:0 0 0 2px rgba(124,58,237,.3),0 10px 30px rgba(124,58,237,.45)}
  .btn.small{padding:8px 10px;border-radius:10px}
  .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)}
  .btnbar{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}

  /* --- UPDATED: make group-count chips stand out more --- */
  .chip{
    padding:4px 10px;border-radius:999px;border:1px solid #2c3a6f;background:#0f1a44;
    font-size:12px;cursor:pointer;
    color:#e6ecff;
    font-weight:900;
    text-shadow:0 0 10px rgba(34,211,238,.35);
  }
  .chip:hover{
    filter:brightness(1.1);
    box-shadow:0 0 0 2px rgba(34,211,238,.18), 0 8px 22px rgba(0,0,0,.25);
  }

  .toggle{display:flex;gap:6px;align-items:center;font-size:12px;color:#a7b3d9}
  .muted{color:#9fb0d8;font-size:12px}

  /* Grouping visuals */
  .mix{position:relative;height:360px;overflow:hidden;border-radius:16px;background:#0b1333}
  .groups{display:grid;gap:18px}
  @media(min-width:700px){.groups{grid-template-columns:1fr 1fr}}
  @media(min-width:1100px){.groups{grid-template-columns:1fr 1fr 1fr}}
  .group{border:1px solid #2c3a6f;border-radius:16px;padding:16px;background:#0b163f}
  .badge{display:inline-block;padding:3px 8px;border-radius:8px;border:1px solid #2c3a6f;background:#0f1a44}
  .empty{border:2px dashed #2c3a6f;color:#89a0da;text-align:center;padding:36px;border-radius:16px;background:rgba(11,19,63,.4)}
  .toolbar{display:flex;gap:10px;justify-content:flex-end;margin-bottom:8px}

  /* Wheel */
  .wheel-wrap{display:grid;gap:16px;margin-top:18px}
  @media(min-width:840px){.wheel-wrap{grid-template-columns:1fr 1fr}}
  .wheel-box{position:relative;display:flex;align-items:center;justify-content:center;aspect-ratio:1/1;border-radius:16px;background:#0b1333;border:1px solid #2c3a6f;overflow:hidden}
  #wheelCanvas{width:100%;height:100%}
  .pointer{position:absolute;top:8px;left:50%;transform:translateX(-50%);
    width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:22px solid #f8fafc;filter:drop-shadow(0 4px 10px rgba(0,0,0,.6))}
  .winner-banner{display:flex;align-items:center;justify-content:center;min-height:64px;border:1px solid #2c3a6f;border-radius:12px;background:#0f1a44;font-weight:900}
  .hitpill{display:inline-block;padding:4px 8px;border:1px solid #2c3a6f;border-radius:999px;margin-left:8px;font-size:12px;background:#0b163f;font-weight:800}
  .winner-pop{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .winner-pop .chip{padding:10px 16px;border-radius:999px;font-weight:900;background:rgba(255,255,255,.94);color:#0b1026;border:1px solid rgba(0,0,0,.15);box-shadow:0 8px 30px rgba(0,0,0,.35);transform:scale(.9);opacity:0;transition:transform .25s ease,opacity .25s ease}
  .winner-pop.show .chip{transform:scale(1);opacity:1}

  /* Confetti canvas hidden in print */
  @media print{.no-print{display:none !important} body{background:#fff;color:#000} .card{box-shadow:none;border:1px solid #ddd} .wrap{max-width:none;padding:0}}
</style>
</head>
<body>

  <div class="hero"><div class="wrap"><h1 class="neon-title">Student Group Shuffle</h1></div></div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT controls -->
      <div class="card pad">
        <label>Student names</label>
        <textarea id="names" placeholder="One per line, or separated by commas/semicolons/tabs"></textarea>

        <div class="btnbar">
          <button class="btn" id="demo">Load demo</button>
          <button class="btn" id="clear">Clear</button>
        </div>

        <label>Number of groups</label>
        <input type="number" id="groupsCount" min="1" value="3" />
        <div class="chips" id="groupsCountQuick"></div>

        <label>Optional seed (for reproducible shuffle)</label>
        <input type="text" id="seed" placeholder="Type any word or number" />
        <small class="muted">Enter the same seed again to reproduce the same shuffle.</small>

        <div class="btnbar">
          <button class="btn primary" id="shuffle">Shuffle & Group</button>
          <button class="btn" id="printBtn">Print</button>
        </div>
      </div>

      <!-- RIGHT output -->
      <div class="card pad">
        <div class="toolbar">
          <label class="toggle"><input type="checkbox" id="arcadeToggle" checked>Arcade</label>
          <label class="toggle"><input type="checkbox" id="soundToggle" checked>Sound</label>
        </div>

        <div id="mixStage" class="mix" style="display:none"></div>
        <div id="results" style="display:none">
          <div class="muted" id="summary"></div>
          <div class="groups" id="groups"></div>
        </div>
        <div id="empty" class="empty">
          Paste names on the left, choose your grouping, then click <strong>Shuffle & Group</strong>.
        </div>

        <canvas id="confetti" width="10" height="10" class="no-print" style="position:absolute; inset:0; pointer-events:none; display:none;"></canvas>
      </div>
    </div>

    <!-- WHEEL -->
    <div class="card pad" style="margin-top:16px;">
      <h2 style="margin:0 0 8px;font-size:22px;font-weight:900">Wheel Randomizer</h2>
      <div class="muted">Each slice shows remaining picks. Landing auto-decrements; at 0 the student is removed.</div>

      <div class="wheel-wrap">
        <div class="wheel-box">
          <div class="pointer"></div>
          <canvas id="wheelCanvas" width="600" height="600"></canvas>
          <div id="winnerPop" class="winner-pop"><div class="chip" id="winnerChip"></div></div>
        </div>

        <div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label>Remove after N hits</label>
              <select id="hitLimit">
                <option value="1">1 hit</option>
                <option value="2">2 hits</option>
                <option value="3" selected>3 hits</option>
                <option value="4">4 hits</option>
                <option value="5">5 hits</option>
              </select>
            </div>
            <div>
              <label class="toggle" style="margin-top:6px;"><input type="checkbox" id="autoCount" checked>Auto-count on landing</label>
              <label class="toggle" style="margin-top:6px;"><input type="checkbox" id="autoRemove" checked>Auto-remove at threshold</label>
            </div>
          </div>

          <div class="btnbar">
            <button class="btn primary" id="spinBtn">Spin</button>
            <button class="btn" id="shuffleWheel">Shuffle wheel</button>
            <button class="btn" id="resetHits">Reset hit counts</button>
            <button class="btn" id="restoreAll">Restore everyone</button>
            <button class="btn" id="refreshWheel">Refresh from names</button>
          </div>

          <div class="winner-banner" id="winnerBanner">Ready to spin</div>

          <div class="btnbar" style="margin-top:10px;">
            <button class="btn small" id="countHitBtn" disabled>Count hit (keep)</button>
            <button class="btn small" id="undoHitBtn" disabled>Undo last hit</button>
            <button class="btn small" id="removeNowBtn" disabled>Remove now</button>
            <span class="muted" id="poolInfo"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  /* ---------- Utilities ---------- */
  function splitNames(raw){
    if(!raw) return [];
    raw = raw.replace(/\u00A0/g," ");
    return raw
      .split(/\r\n|\n|\r|\u2028|\u2029|,|;|\t/g)
      .map(s=>s.trim())
      .filter(Boolean);
  }
  function mulberry32(a){
    return function(){
      var t=a+=0x6d2b79f5;
      t=Math.imul(t^(t>>>15),t|1);
      t^=t+Math.imul(t^(t>>>7),t|61);
      return((t^(t>>>14))>>>0)/4294967296;
    }
  }
  function hashSeed(str){
    if(str==null||str==="")return null;
    let h=1779033703^str.length;
    for(let i=0;i<str.length;i++){
      h=Math.imul(h^str.charCodeAt(i),3432918353);
      h=(h<<13)|(h>>>19);
    }
    return h>>>0;
  }
  function getRng(seed){
    const h=hashSeed(seed);
    return h==null ? Math.random : mulberry32(h);
  }
  function shuffleArray(arr,rng){
    const a=arr.slice();
    const R=rng||Math.random;
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(R()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  /* ---------- Confetti ---------- */
  const confettiCanvas=document.getElementById("confetti");
  const cctx=confettiCanvas.getContext("2d");
  let confettiTimer=null, confettiParts=[];
  function launchConfetti(n=180){
    const box=confettiCanvas.parentElement.getBoundingClientRect();
    confettiCanvas.width=box.width;
    confettiCanvas.height=box.height;
    confettiCanvas.style.display="block";
    const colors=["#22d3ee","#7c3aed","#f59e0b","#22c55e","#60a5fa","#fb7185"];
    confettiParts = Array.from({length:n},()=>({
      x:Math.random()*box.width,
      y:-10-Math.random()*120,
      w:6+Math.random()*7,
      h:10+Math.random()*14,
      c:colors[Math.floor(Math.random()*colors.length)],
      vx:-2+Math.random()*4,
      vy:2+Math.random()*5,
      r:Math.random()*360,
      vr:-6+Math.random()*12
    }));
    cancelAnimationFrame(confettiTimer);
    (function tick(){
      cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
      confettiParts.forEach(p=>{
        p.x+=p.vx;
        p.y+=p.vy;
        p.vy+=0.06;
        p.r+=p.vr;
        cctx.save();
        cctx.translate(p.x,p.y);
        cctx.rotate(p.r*Math.PI/180);
        cctx.fillStyle=p.c;
        cctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
        cctx.restore();
      });
      confettiParts=confettiParts.filter(p=>p.y<confettiCanvas.height+50);
      if(confettiParts.length) confettiTimer=requestAnimationFrame(tick);
    })();
    setTimeout(()=>confettiCanvas.style.display="none",2000);
  }

  /* ---------- Sound ---------- */
  const SPIN_SFX_URL = "wheel-spin.mp3"; // <-- put your attached mp3 next to this HTML and name it wheel-spin.mp3
  const spinSfx = new Audio(SPIN_SFX_URL);
  spinSfx.preload = "auto";
  spinSfx.volume = 0.7;

  function playSpinSfx(){
    try{
      spinSfx.pause();
      spinSfx.currentTime = 0;
      spinSfx.play().catch(()=>{});
    }catch(e){}
  }

  // keep the "winner coin" from WebAudio
  let audioCtx=null;
  function ensureAudio(){
    audioCtx=audioCtx||new (window.AudioContext||window.webkitAudioContext)();
    return audioCtx;
  }
  function coin(){
    const ctx=ensureAudio();
    const n=ctx.currentTime;
    function b(f,t,l,v){
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.type="sine";
      o.frequency.value=f;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0,t);
      g.gain.linearRampToValueAtTime(v,t+.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t+l);
      o.start(t); o.stop(t+l);
    }
    b(880,n,.15,.25);
    b(1320,n+.07,.15,.22);
    b(1760,n+.14,.13,.20);
  }

  /* ---------- DOM refs ---------- */
  const elNames=document.getElementById("names");
  const elGroupsCount=document.getElementById("groupsCount");
  const elGroupsCountQuick=document.getElementById("groupsCountQuick");
  const elSeed=document.getElementById("seed");
  const elShuffle=document.getElementById("shuffle");
  const elPrint=document.getElementById("printBtn");
  const elDemo=document.getElementById("demo");
  const elClear=document.getElementById("clear");
  const elEmpty=document.getElementById("empty");
  const elResults=document.getElementById("results");
  const elSummary=document.getElementById("summary");
  const elGroupsOut=document.getElementById("groups");
  const elArcade=document.getElementById("arcadeToggle");
  const elSound=document.getElementById("soundToggle");

  /* ---------- Quick chips ---------- */
  [2,3,4,5,6,7,8,9,10].forEach(n=>{
    const b=document.createElement("button");
    b.className="chip";
    b.textContent=n;
    b.onclick=()=>{elGroupsCount.value=n};
    elGroupsCountQuick.appendChild(b);
  });

  /* ---------- Demo / Clear ---------- */
  elDemo.onclick=()=>{
    elNames.value=[
      "Sam","Bobby","Kristen","Tanaja","Jennifer","Gabby","Prince",
      "Walter","Brian","Larry","Craig","John","Ben","Trolus","Shannon"
    ].join("\n");
    drawWheel();
  };
  elClear.onclick=()=>{
    elNames.value="";
    elSeed.value="";
    elResults.style.display="none";
    elEmpty.style.display="";
    resetHitsAll();
    removed.clear();
    lastPick=null;
    drawWheel();
    setWinner("Ready to spin");
  };
  elPrint.onclick=()=>window.print();

  /* ---------- Grouping ---------- */
  function renderResults(totalCount,groups){
    elResults.style.display="";
    elEmpty.style.display="none";
    const sizes=groups.map(g=>g.length);
    const min=sizes.length?Math.min(...sizes):0;
    const max=sizes.length?Math.max(...sizes):0;
    elSummary.textContent=`${totalCount} students â†’ ${groups.length} groups (sizes ${min}-${max})`;
    elGroupsOut.innerHTML="";
    groups.forEach((g,i)=>{
      const d=document.createElement("div");
      d.className="group";
      d.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">GROUP ${i+1}</h3><span class="badge">${g.length}</span></div>
        <ol style="margin:8px 0 0;padding-left:22px">${g.map(n=>`<li>${n}</li>`).join("")}</ol>`;
      elGroupsOut.appendChild(d);
    });
  }

  elShuffle.onclick=()=>{
    const names=splitNames(elNames.value);
    if(!names.length){
      alert("Please paste at least one name.");
      return;
    }
    const rng=getRng(elSeed.value);
    const shuffled = shuffleArray(names, rng);
    const k=Math.max(1,Math.min(shuffled.length,Math.floor(elGroupsCount.value||"1")));
    const size=Math.ceil(shuffled.length/k);
    const groups=[];
    for(let i=0;i<shuffled.length;i+=size) groups.push(shuffled.slice(i,i+size));

    if(elArcade.checked && elSound.checked) playSpinSfx();

    setTimeout(()=>{
      renderResults(names.length,groups);
      if(elArcade.checked){
        if(elSound.checked) coin();
        launchConfetti(220);
      }
    }, elArcade.checked?1100:0);
  };

  /* ---------- WHEEL ---------- */
  const wheelCanvas=document.getElementById("wheelCanvas");
  const wctx=wheelCanvas.getContext("2d");
  const spinBtn=document.getElementById("spinBtn");
  const shuffleWheelBtn=document.getElementById("shuffleWheel");
  const winnerBanner=document.getElementById("winnerBanner");
  const hitLimitEl=document.getElementById("hitLimit");
  const autoRemoveEl=document.getElementById("autoRemove");
  const autoCountEl=document.getElementById("autoCount");
  const resetHitsBtn=document.getElementById("resetHits");
  const restoreAllBtn=document.getElementById("restoreAll");
  const refreshWheelBtn=document.getElementById("refreshWheel");
  const countHitBtn=document.getElementById("countHitBtn");
  const undoHitBtn=document.getElementById("undoHitBtn");
  const removeNowBtn=document.getElementById("removeNowBtn");
  const poolInfo=document.getElementById("poolInfo");
  const winnerPop=document.getElementById("winnerPop");
  const winnerChip=document.getElementById("winnerChip");

  const palette=[
    "#22d3ee","#7c3aed","#f59e0b","#22c55e",
    "#60a5fa","#fb7185","#a78bfa","#34d399",
    "#fca5a5","#93c5fd"
  ];
  const POINTER_AT = Math.PI/2; // pointer visually at top

  let hits=new Map();
  let removed=new Set();
  let spinning=false, angle=0;
  let lastPick=null, lastCounted=null, highlightName=null;
  let spinPoolSnapshot=null;
  let autoCountApplied=false;

  function currentNames(){ return splitNames(elNames.value); }
  function maxHits(){ return parseInt(hitLimitEl.value,10)||3; }
  function remainingFor(name){ return Math.max(0, maxHits() - (hits.get(name)||0)); }
  function activePoolUnlocked(){
    const names=currentNames();
    return names.filter(n=>!removed.has(n) && remainingFor(n)>0);
  }
  function activePool(){ return spinPoolSnapshot ? spinPoolSnapshot.slice() : activePoolUnlocked(); }

  function setWinner(text,name=null){
    winnerBanner.textContent=text;
    if(name){
      const rem=remainingFor(name);
      const pill=document.createElement("span");
      pill.className="hitpill";
      pill.textContent=`Remaining: ${rem}`;
      winnerBanner.appendChild(pill);
    }
  }
  function showCenterChip(name){
    winnerChip.textContent=name;
    winnerPop.classList.add("show");
    setTimeout(()=>winnerPop.classList.remove("show"), 900);
  }

  function drawWheel(){
    const pool=activePool();
    poolInfo.textContent=`Pool: ${pool.length} active`;
    const cx=wheelCanvas.width/2, cy=wheelCanvas.height/2;
    const r=Math.min(cx,cy)-6;
    wctx.clearRect(0,0,wheelCanvas.width,wheelCanvas.height);

    if(pool.length===0){
      wctx.beginPath();
      wctx.arc(cx,cy,r,0,Math.PI*2);
      wctx.fillStyle="#0f1a44"; wctx.fill();
      wctx.strokeStyle="#2c3a6f"; wctx.lineWidth=2; wctx.stroke();
      wctx.fillStyle="#cbd5ff";
      wctx.font="bold 22px system-ui,-apple-system,Segoe UI,Roboto,Arial";
      wctx.textAlign="center"; wctx.textBaseline="middle";
      wctx.fillText("No active names",cx,cy);
      countHitBtn.disabled=undoHitBtn.disabled=removeNowBtn.disabled=true;
      return;
    }

    const slice=Math.PI*2/pool.length;
    const dimOthers=!!highlightName;

    for(let i=0;i<pool.length;i++){
      const start=angle+i*slice;
      const end=start+slice;
      const name=pool[i];
      const rem=remainingFor(name);
      const isW=highlightName && (name===highlightName);

      wctx.beginPath();
      wctx.moveTo(cx,cy);
      wctx.arc(cx,cy,r,start,end);
      wctx.closePath();
      const fill=palette[i%palette.length];
      wctx.fillStyle=dimOthers&&!isW?fill+"E6":fill;
      wctx.fill();
      wctx.strokeStyle=isW?"#fff":"rgba(0,0,0,.3)";
      wctx.lineWidth=isW?3:1;
      wctx.stroke();

      const mid=start+slice/2;
      const lr=r*0.72;
      const tx=cx+Math.cos(mid)*lr;
      const ty=cy+Math.sin(mid)*lr;
      wctx.save();
      wctx.translate(tx,ty);
      wctx.rotate(mid+Math.PI/2);
      wctx.textAlign="center";
      wctx.textBaseline="middle";
      wctx.fillStyle="#0b1026";
      wctx.font="bold 16px system-ui,-apple-system,Segoe UI,Roboto,Arial";
      if(pool.length>16) wctx.font="bold 12px system-ui,-apple-system,Segoe UI,Roboto,Arial";
      if(pool.length>28) wctx.font="bold 10px system-ui,-apple-system,Segoe UI,Roboto,Arial";
      wctx.fillText(name,0,-8);

      wctx.beginPath();
      wctx.arc(0,12,14,0,Math.PI*2);
      wctx.fillStyle=isW?"rgba(255,255,255,1)":"rgba(255,255,255,.9)";
      wctx.fill();
      wctx.lineWidth=2;
      wctx.strokeStyle="rgba(0,0,0,.15)";
      wctx.stroke();
      wctx.fillStyle="#0b1026";
      wctx.font="900 14px system-ui,-apple-system,Segoe UI,Roboto,Arial";
      wctx.fillText(String(rem),0,12.5);
      wctx.restore();
    }

    wctx.beginPath();
    wctx.arc(cx,cy,r,0,Math.PI*2);
    wctx.lineWidth=6;
    wctx.strokeStyle="#0f1a44";
    wctx.stroke();
  }

  function lockSpinPool(){ spinPoolSnapshot = activePoolUnlocked(); }
  function unlockSpinPool(){ spinPoolSnapshot = null; }

  function spin(){
    const pool = activePoolUnlocked();
    if(pool.length===0){
      alert("No active names. Add names, or restore everyone.");
      return;
    }
    if(spinning) return;

    lockSpinPool();
    autoCountApplied=false;
    highlightName=null;
    drawWheel();

    if(elArcade.checked && elSound.checked) playSpinSfx();

    setWinner("Spinning...");
    winnerPop.classList.remove("show");

    spinning=true;
    countHitBtn.disabled=true;
    undoHitBtn.disabled=true;
    removeNowBtn.disabled=true;

    const rng=getRng(elSeed.value);
    const targetIndex=Math.floor((rng?rng():Math.random())*pool.length);
    const slice=Math.PI*2/pool.length;

    const midpointAngle = (POINTER_AT + Math.PI) - (targetIndex*slice + slice/2);
    const extraSpins = 3 + Math.floor(Math.random()*2);
    const start=performance.now(), duration=3200, startAngle=angle;
    const target = midpointAngle + extraSpins*2*Math.PI;
    function ease(t){ return 1 - Math.pow(1-t,3); }

    (function frame(now){
      const t=Math.min(1,(now-start)/duration);
      angle = startAngle + (target - startAngle) * ease(t);
      drawWheel();
      if(t<1){
        requestAnimationFrame(frame);
      } else {
        spinning=false;
        angle = ((midpointAngle % (2*Math.PI)) + 2*Math.PI) % (2*Math.PI);
        const name = pool[targetIndex];
        lastPick = { name, indexAtSpin: targetIndex, poolSnapshot: pool.slice() };

        if(elArcade.checked){
          if(elSound.checked) coin();
          launchConfetti(140);
        }
        highlightName = name;
        drawWheel();
        showCenterChip(name);

        if(autoCountEl.checked){
          applyWinnerHit(name);
        } else {
          setWinner(name,name);
          countHitBtn.disabled=false;
          undoHitBtn.disabled=lastCounted?false:true;
          removeNowBtn.disabled=false;
        }
        unlockSpinPool();
      }
    })(performance.now());
  }

  function applyWinnerHit(name){
    if(autoCountApplied) return;
    autoCountApplied = true;
    const prev = hits.get(name)||0;
    hits.set(name, prev+1);
    lastCounted = { name };
    const rem = remainingFor(name);
    if(autoRemoveEl.checked && rem<=0){
      removed.add(name);
      setWinner(`${name} reached 0 and was removed.`, name);
    } else {
      setWinner(`${name} counted.`, name);
    }
    drawWheel();
    undoHitBtn.disabled=false;
    countHitBtn.disabled=true;
    removeNowBtn.disabled=false;
  }

  function countHit(){
    if(!lastPick) return;
    applyWinnerHit(lastPick.name);
  }

  function undoHit(){
    if(!lastCounted) return;
    const {name}=lastCounted;
    const h=hits.get(name)||0;
    if(h>0) hits.set(name,h-1);
    removed.delete(name);
    setWinner(`Undid last hit for ${name}.`, name);
    lastCounted=null;
    autoCountApplied=false;
    drawWheel();
    undoHitBtn.disabled=true;
  }

  function removeNow(){
    if(!lastPick) return;
    removed.add(lastPick.name);
    setWinner(`${lastPick.name} removed.`, lastPick.name);
    drawWheel();
  }

  function resetHitsAll(){
    hits.clear();
    lastCounted=null;
    autoCountApplied=false;
    undoHitBtn.disabled=true;
    drawWheel();
  }

  function restoreAll(){
    removed.clear();
    resetHitsAll();
    setWinner("Everyone restored");
  }

  function shuffleWheelOrder(){
    const names = splitNames(elNames.value);
    if(!names.length){
      alert("Please paste at least one name to shuffle.");
      return;
    }
    const rng = getRng(elSeed.value);
    const shuffled = shuffleArray(names, rng);
    elNames.value = shuffled.join("\n");
    highlightName = null;
    drawWheel();
    setWinner("Wheel shuffled");
  }

  /* ---------- Bindings ---------- */
  spinBtn.onclick=spin;
  shuffleWheelBtn.onclick = shuffleWheelOrder;
  countHitBtn.onclick=countHit;
  undoHitBtn.onclick=undoHit;
  removeNowBtn.onclick=removeNow;
  resetHitsBtn.onclick=()=>{ resetHitsAll(); setWinner("Hit counts reset"); };
  restoreAllBtn.onclick=restoreAll;
  refreshWheelBtn.onclick=()=>{ drawWheel(); setWinner("Wheel refreshed from names"); };
  hitLimitEl.onchange=()=>{ drawWheel(); if(lastPick) setWinner(winnerBanner.textContent, lastPick.name); };
  elNames.oninput=()=>{ drawWheel(); };

  /* ---------- Init ---------- */
  drawWheel();
  setWinner("Ready to spin");
</script>
</body>
</html>
